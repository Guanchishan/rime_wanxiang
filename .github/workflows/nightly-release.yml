name: Nightly Release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *" # 每天晚上 10 点触发

jobs:
  nightly-build:
    runs-on: ubuntu-latest

    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 打包 cn_dicts 文件夹为 ZIP 文件
      - name: Create ZIP archive
        run: |
          if [ -d "cn_dicts" ]; then
            mkdir -p dist
            zip -r dist/wanxiang.dict-nightly.zip cn_dicts
          else
            echo "Error: cn_dicts folder does not exist."
            exit 1
          fi

      # 删除现有 Release（如果存在）
      - name: Delete existing Release
        uses: actions/github-script@v6
        with:
          script: |
            const tag = "dict-nightly";
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const existingRelease = releases.data.find(r => r.tag_name === tag);
            if (existingRelease) {
              console.log(`Deleting existing Release with ID: ${existingRelease.id}`);
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: existingRelease.id
              });

              console.log(`Deleting tag: ${tag}`);
              await github.rest.git.deleteRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `tags/${tag}`
              });
            } else {
              console.log(`No existing Release found for tag: ${tag}`);
            }

      # 创建新的 Release
      - name: Create new Release
        id: create_release
        uses: actions/github-script@v6
        with:
          script: |
            const tag = "dict-nightly";
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: "Nightly Release",
              body: "Nightly build release with updated assets.",
              draft: false,
              prerelease: true
            });

            console.log("Release created:", release.data);
            core.setOutput("upload_url", release.data.upload_url);

      # 上传新资产
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/wanxiang.dict-nightly.zip
          asset_name: wanxiang.dict-nightly.zip
          asset_content_type: application/zip

