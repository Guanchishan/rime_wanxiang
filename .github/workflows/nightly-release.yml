name: Nightly Release

on:
  workflow_dispatch: # 手动触发选项
  schedule:
    - cron: "0 22 * * *" # 每天晚上 10 点触发

jobs:
  nightly-build:
    runs-on: ubuntu-latest

    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 打包 cn_dicts 文件夹为 ZIP 文件，添加 "每夜" 标识
      - name: Create ZIP archive
        run: |
          if [ -d "cn_dicts" ]; then
            mkdir -p dist
            zip -r dist/wanxiang.dict-nightly.zip cn_dicts
            echo "ZIP archive created: dist/wanxiang.dict-nightly.zip"
          else
            echo "Error: cn_dicts folder does not exist."
            exit 1
          fi

      # 创建新的 Release，不包含默认的 Source code 资产
      - name: Create new Release
        id: create_release
        uses: actions/github-script@v6
        with:
          github_token: ${{ secrets.AMZ_TOKEN }}
          script: |
            const tag = "dict-nightly";
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: "每夜自动替换更新词库",
              draft: false,
              prerelease: true,
              generate_release_notes: false # 禁用默认 Source code 打包
            });

            console.log("Release created:", release.data);
            core.setOutput("upload_url", release.data.upload_url);

      # 上传自定义资产
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: dist/wanxiang.dict-nightly.zip
          asset_name: wanxiang.dict-nightly.zip
          asset_content_type: application/zip

